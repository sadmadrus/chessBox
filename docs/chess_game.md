# Сервис игры в шахматы

Сервис реализует игру в шахматы между двумя игроками.

## Описание работы

Игра создаётся сервисом по запросу (предположительно, от сервиса игровых сессий), может быть прекращена (удалена) и/или отложена по запросу. В случае, если игра доиграна до конца, сервис уведомляет об этом и удаляет игру (после таймаута; таймаут настраивается в конфиге сервиса).

В ходе игры сервис принимает ходы от каждой из сторон, а также предложения ничьей и откладывания игры, а также уведомления о сдаче.

### Откладывание игры

Любой игрок может заявить о желании отложить игру, отправив соответствующий запрос. Если второй игрок также отправляет такой запрос, следующий ход (независимо от того, кем он сделан) будет записан, но не должен быть сообщён оппоненту; игра будет отложена в этом состоянии.

### Возврат хода

Игрок, сделавший ход ошибочно (например, не справившись с интерфейсом) может попросить о возврате хода, отправив соответствующий запрос. Если оппонент соглашается с возвратом (отправляя такой же запрос), состояние игры возвращается к положению на момент соответствующего хода, ход (один или два полухода) отменяется, время, затраченное после отменяемого хода, возвращается (но время, затраченное на обдумывание отменённого хода, не возвращается).

Просьба о возврате считается отозванной, если игрок, запросивший возврат хода, сделал ещё один ход; он может заявить новую просьбу о возврате — теперь уже этого последнего хода, а если эта просьба будет удовлетворена — повторно просить о возврате предыдущего.

### Предложение ничьей

Ничья может быть предложена в любой момен любым из игроков. Предложение может быть отозвано, пока оно не принято. Если второй игрок также выдвигает такое предложение (тем самым заявляя о согласии на ничью), предложение считается принятым, и ничья фиксируется как исход партии.

## API

### Начало игры

> ПРИМЕР
> 
> **POST** _сервис_ HTTP/1.1  
> Host: chessbox.example  
> Content-Type: application/x-www-form-urlencoded  
>   
> notify=http://gamescoordinator.chessbox.example:4321/endpoint  
> white=http://playergate2.chessbox.example/player  
> black=http://playergate8.chessbox.example  
> position=4k2r/6r1/8/8/8/8/3R4/R3K3 w Qk - 0 46  
> timing=40/90 SD/30 +30  
> timewhite=495  
> timeblack=208  
> move1=e2e4 2 e7e5 3  
> move2=g1f3 3 b8c6 1  
> [...]  
> move45=g2d2 15 d7g7 6
>
> 
> HTTP/1.1 201 Created  
> Location: GAME1122334455

Сервис принимает запрос `POST` с набором параметров в виде `x-www-form-urlencoded` и создаёт игру с заданными параметрами (параметры `notify`, `white` и `black` обязательны):

- `notify` — URL, на который будут отправляться запросы с уведомлениями для сервиса управления игровыми сессиями;
- `white`, `black` — URL, на который будут дублироваться запросы с уведомлениями для игрока белыми/чёрными, соответственно (гейты игроков);
- `position` — стартовая позиция в FEN, по умолчанию — `rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1`;
- `timing` — формат времени для игры (по умолчанию — игра без учёта времени)
  - в нотации FIDE для классических шахмат (через пробел):
    - `NN/MM` — на (очередные) NN ходов каждому игроку добавляется MM минут,
    - `G/MM` — на всю игру каждому игроку даётся MM минут,
    - `SD/MM` — на остаток игры каждому игроку добавляется MM минут,
    - указание в конце `d/SS` или `+SS` означает задержку таймера или инкремент на `SS` секунд на каждом ходу, соответственно;
  - в нотации FIDE для быстрых шахмат (через `|`):
    - `MM` — на всю игру каждому игроку даётся MM минут, без инкремента, или
    - `MM|SS` — на всю игру каждому игроку даётся MM минут с инкрементом SS секунд на каждом ходу;
- `move1`..`moveXX` — описание сделанных ходов в формате: UCI(белые)-время-UCI(чёрные)-время, через пробел; последний из этих параметров может содержать только полуход, если на доске ход чёрных; затраченное на ход время указывается в секундах; в случае, если параметр `position` указан, и позиция, приведённая в нём, отличается от классической стартовой, ходы отсчитываются от этой указанной стартовой позиции;
- `timewhite`, `timeblack` — время на часах игроков белыми/чёрными на момент начала игры, соответственно (в секундах); по умолчанию — полное время перед первым ходом для заданного формата времени. Эти параметры имеют приоритет над `timing`, даже если на доске — первый ход белых, и имеют приоритет над вычисленным временем по ходам.

**Возможные ответы**:

- `201 Created` — игра создана, в заголовке `Location` возвращается ID созданной игры;
- `400 Bad Request` — отсутствует обязательный параметр, или заданы некорректные параметры (невозможная позиция, нулевое/отрицательное время и т.п.);
- `408 Request Timeout` — не получен ответ от сервера по адресу `notify`, игра не создана.

### В ходе игры

Сервис принимает запросы по адресу, _path_ которого совпадает с ID игры.

Во всех случаях, кроме ответа с кодом `404 Game Not Found` (может быть дан на любой запрос, если игры с заданным ID в сервисе нет), тело ответа содержит JSON с позицией на доске (в том числе если она осталась без изменений), состоянием игры (продолжается, окончена, предложена ничья и т.п.) и временем в секундах на часах каждого игрока.

#### Очередной ход

> ПРИМЕР
> 
> **PUT** _сервис/GAME1122334455_ HTTP/1.1  
> Host: chessbox.example  
> Content-Type: application/x-www-form-urlencoded  
> 
> player=white  
> move=e2e4  
> time=24  
> 
> HTTP/1.1 200 OK  

Сервис принимает запрос `PUT` с набором параметров в виде `x-www-form-urlencoded`, и обрабатывает соответствующий ход. Параметры обязательны, если иное не указано явно:

- `player` — сторона, делающая ход ("white" или "black");
- `move` — ход в нотации [UCI](https://en.wikipedia.org/wiki/Universal_Chess_Interface) (`e7e5`, `a7a8q`, `e1g1` (рокировка));
- `time` — (необязательный параметр) для игр с контролем времени — время, затраченное на ход, в секундах (которое гейт может измерить как время, прошедшее от предъявления игроку хода до получения нового хода от игрока). Если игра идёт с контролем времени, а этот параметр отсуствует, время, затраченное на ход, будет учтено самим сервисом игры, и будет включать время, затраченное на передачу информации между гейтом и сервисом.

**Возможные ответы**:

- `200 OK` — ход зафиксирован;
- `400 Bad Request` — отсутствует обязательный параметр, или заданы некорректные параметры (игрок `blue`, ход `r10x18`, и т.п.);
- `403 Forbidden` — ход нарушает правила;
- `404 Game Not Found`;
- `409 Conflict` — ход нарушает очерёдность (т.е. сделан белыми, хотя очередь хода за чёрными, и наоборот).

#### Просьба об отмене хода

> ПРИМЕР
> 
> **PUT** _сервис/GAME1122334455_ HTTP/1.1  
> Host: chessbox.example  
> Content-Type: application/x-www-form-urlencoded  
> 
> player=white  
> takeback=true  
>
> 
> HTTP/1.1 200 OK

Сервис принимает запрос `PUT` с набором параметров в виде `x-www-form-urlencoded`, и обрабатывает соответствующий ход. Оба параметра обязательны:

- `player` — сторона, делающая ход ("white" или "black");
- `takeback` — может быть только "true".

**Возможные ответы**:

- `200 OK` — просьба зафиксирована;
- `400 Bad Request` — отсутствует обязательный параметр, или заданы некорректные параметры (игрок `blue`, `takeback` не "true", и т.п.);
- `404 Game Not Found`;
- `409 Conflict` — невозможное изменение (уже на первом ходе, нечего отменять).

#### Предложение ничьей

> ПРИМЕР
> 
> **PUT** _сервис/GAME1122334455_ HTTP/1.1  
> Host: chessbox.example  
> Content-Type: application/x-www-form-urlencoded  
> 
> player=white  
> drawoffer=true  
>
> 
> HTTP/1.1 200 OK

Сервис принимает запрос `PUT` с набором параметров в виде `x-www-form-urlencoded`, и обрабатывает информацию о предложении ничьей. Оба параметра обязательны:

- `player` — сторона, делающая предложение ("white" или "black");
- `drawoffer` — предложение сделано (`true`) или отозвано (`false`).

**Возможные ответы**:

- `200 OK` — предложение зафиксировано (или зафиксирован отзыв);
- `400 Bad Request` — отсутствует обязательный параметр, или заданы некорректные параметры (игрок `blue`, предложение `maybe`, и т.п.);
- `404 Game Not Found`;
- `409 Conflict` — невозможное изменение (ничья уже принята и не может быть отозвана, или игра окончена).

#### Предложение отложить игру

> ПРИМЕР
> 
> **PUT** _сервис/GAME1122334455_ HTTP/1.1  
> Host: chessbox.example  
> Content-Type: application/x-www-form-urlencoded  
> 
> player=white  
> adjourn=true  
>
> 
> HTTP/1.1 200 OK

Сервис принимает запрос `PUT` с набором параметров в виде `x-www-form-urlencoded`, и обрабатывает информацию о предложении отложить игру. Оба параметра обязательны:

- `player` — сторона, делающая предложение ("white" или "black");
- `adjourn` — предложение сделано (`true`) или отозвано (`false`).

**Возможные ответы**:

- `200 OK` — предложение зафиксировано (или зафиксирован отзыв);
- `400 Bad Request` — отсутствует обязательный параметр, или заданы некорректные параметры (игрок `blue`, предложение `maybe`, и т.п.);
- `404 Game Not Found`;
- `409 Conflict` — невозможное изменение (игра уже окончена).

#### Сдача

> ПРИМЕР
> 
> **PUT** _сервис/GAME1122334455_ HTTP/1.1  
> Host: chessbox.example  
> Content-Type: application/x-www-form-urlencoded  
> 
> player=white  
> forfeit=true  
>
> 
> HTTP/1.1 200 OK

Сервис принимает запрос `PUT` с набором параметров в виде `x-www-form-urlencoded`, и обрабатывает информацию о желании сдаться («уронить короля»). Оба параметра обязательны:

- `player` — сдающаяся сторона ("white" или "black");
- `forfeit` — король «положен» на доску (только `true`).

**Возможные ответы**:

- `200 OK` — сдача зафиксирована;
- `400 Bad Request` — отсутствует обязательный параметр, или заданы некорректные параметры (игрок `blue`, предложение `false`, и т.п.);
- `404 Game Not Found`;
- `409 Conflict` — невозможное изменение (игра уже окончена).

#### Прекращение игры

> ПРИМЕР
> 
> **DELETE** _сервис/GAME1122334455_ HTTP/1.1  
> Host: chessbox.example  
>
> 
> HTTP/1.1 200 OK

Сервис принимает запрос `DELETE` и удаляет соответствующую игру из сервиса (игровая сессия уничтожается и более не доступна никакими средствами).

**Возможные ответы**:

- `200 OK`;
- `404 Game Not Found`.

#### Состояние игры

> ПРИМЕР
> 
> **GET** _сервис/GAME1122334455_ HTTP/1.1  
> Host: chessbox.example  
>
> 
> HTTP/1.1 200 OK

Сервис принимает запрос `GET` и возвращает информацию о состоянии игры.

**Возможные ответы**:

- `200 OK` — информация об игре в теле ответа;
- `404 Game Not Found`.

### Уведомления

В процессе игры сервис высылает уведомления об изменениях в ходе игры. Уведомления отправляются в виде запросов `PUT` на адреса, заданные при создании игры, и содержат информацию в виде `x-www-form-urlencoded`.

Следующие поля (параметры) содержатся в любом уведомлении:

- `game` — ID игры;
- `position` — текущая позиция в FEN;
- `whitecandraw`, `blackcandraw` — возможность ("true"/"false") для белых или чёрных, соответственно, объявить ничью: ход принадлежит соответствующему игроку, плюс выполняется одно из условий:
  - троекратное повторение позиции на доске;
  - 50 ходов без движения пешек и взятий фигур;
  - оппонентом предложена ничья, и это предложение не отозвано.

Следующие поля (параметры) содержатся в уведомлении, когда наступило соответствующие событие:

- `movemade` — сделан ход ("white" или "black");
- `move` — ход в нотации UCI (если `movemade`);
- `takeback` — запрошена отмена хода ("white" или "black" — при запросе, "true" — при подтверждении);
- `whiteclock`, `blackclock` — время в секундах на часах (если игра с контролем времени);
- `gameover` — исход игры ("white", "black" или "draw");
- `flagfall` — истекло время ("white" или "black");
- `adjourn` — один из игроков попросил отложить игру ("white", "black" или "false", если предложение отозвано);
- `gameadjourned` — игра успешно отложена (только значение "true").

### Окончание и откладывание

При окончании или откладывании игры сервис дополнительно отправляет данные об игре в виде запроса `POST` на адрес `notify`, указанный при создании игры. Тело запроса в виде JSON содержит полную историю игры (стартовая позиция, контроль времени, каждый ход (и затраченное на него время — если игра с контролем времени), итоговая позиция и часы каждого игрока).