# Сервис проверки позиции на доске

Сервис отвечает за проверку легальности позиции, т.е. того, могла ли данная позиция возникнуть в ходе партии, где начальное положение фигур и каждый из ходов соответствовали правилам.

Реализован в `internal/board/position`.

## API

Сервис отвечает на входящий HTTP-запрос (`GET` или `HEAD`), содержащий в качестве параметра URL `board` позицию в нотации usFEN. Ответ содержится в коде (HTTP Status), тело ответа всегда пустое.

### Возможные коды ответа:

- `200 (OK)` — позиция на доске легальна.
- `403 (Forbidden)` — позиция на доске нелегальна.
- `400 (Bad Request)` — URL не содержит параметра `board`.
- `405 (Method Not Allowed)` — метод запроса отличается от `GET` или `HEAD`.


## Ограничения функционала

Не доказано, что возможно корректно определить все нелегальные позиции, не восстанавливая полностью возможную последовательность ходов. Решено проверять наиболее очевидные ограничения; таким образом, сервис может счесть валидной позицию, которая таковой не является (но не наоборот).

### Выполняемые проверки

- Существует один и только один король каждого цвета.
- Король цвета, у которого нет хода (в том смысле, что ход у другой стороны), не находится под шахом.
- Король цвета, имеющего ход, находится под шахом не больше, чем двойным; если шах двойной, то это не два слона, не два коня, не пешка+пешка, не пешка+конь, не пешка+слон.
- На доске не больше 8 пешек каждого цвета.
- На горизонталях 1 и 8 пешек нет.
- В случае, если открыто взятие на проходе, перед «проходным» полем находится пешка нужного цвета, проходное поле и поле за ним пусты.
- Количество фигур соответствует количеству недостающих пешек: два ферзя и три ладьи одного цвета требуют не более шести пешек этого цвета на доске, и т. д. Учесть, что из двух однопольных одноцветных слонов один — проведённый.
- Король не на месте не сочетается с возможностью рокировки, аналогично для ладьи.

### Проверки, которые (пока) не реализованы

- Конфигурация пешек должна хотя бы примерно соответствовать количеству фигур на доске; так, 6 белых пешек на вертикали h возможны только в том случае, если у чёрных на доске не осталось ничего, кроме короля (и вряд ли такая позиция возникла в реальной игре).
- Белые пешки на h2 и h3 означают, что белой пешки на g2 быть не может, и т.д.
- Белый слон может быть заперт на 1-й горизонтали пешками только на своей стартовой позиции (т.е. невозможна позиция с белым слоном на e1 и белыми пешками на d2 и f2, например). При наличии белых пешек на d2 и f2 чёрный слон может оказаться на e1 только в результате проведения туда пешки; если белая пешка есть и на e2, чёрного слона на e1 быть не может вообще. Аналогично для 8-й горизонтали.