# Сервис логирования

Документация (Beta) для сервиса, который будет хранить историю действий всего приложения, сообщения об ошибках, активность игроков и результаты партий. Предполагается, что буквальная нотация каждого хода в каждой партии будет использоваться только в рамках отладки работы сервиса, а храним данные только о результате игр. Подробное описание логики работы приложения см. [здесь](arch.md) 

## Общее описание

Событие - действие пользователя, которое изменяет (или создаёт запрос на изменение) данных в БД сервиса.
Для упрощения выделим две большие группы событий, которые должны порождать запись в логе.

### Игровые события

к ИС следует относить:

1. Создание партии
2. Прекращение партии с различными статусами: ничья/победа/прерывание. Дополнительно статусы должны включать комментарии:
   * **НИЧЬЯ**:
     * по соглашению сторон
     * недостаточно материала
     * позиционная ничья ("крепость" или "мёртвая позиция", равенство материала)  *не стоит считать отдельно, слишком много вариантов*
     * троекратное повторение позиции
     * 50 ходов без взятия/продвижения пешек
   * **ПРЕРЫВАНИЕ**:
     * отмена партии одним из игроков до своего первого хода
     * отключение клиента по определённому timeout
     * долго висящая без активности партия
   * **ПОБЕДА**:
     * игрок сдался
     * поставлен мат
     * упал флаг (при реализации игры на время)
3. Сделан валидный ход
4. Предложена ничья (в рамках одной партии каждый игрок имеет только одно предложение ничьей). Принятие - в п 2,  отказ не логируется.
*Важно решить: при активном предложении на ничью время идёт и доска неактивна (всплывающее модальное окно) или партия продолжается в нормальном режиме?*

### Неигровые события

Неигровые события, требующие логирования:

* регистрация в системе  (новый игрок)
* подтверждение регистрации
* авторизация в системе
* изменение данных аккаунта
* изменение пароля
* блокировка аккаунта
* удаление аккаунта
* добавление игроков в friendlist
* добавление игроков в blacklist
* системные ошибки доступа к БД
* многократные (5+) попытки авторизации с некорректной парой логин-пароль
* старт микросервиса
* результат работы микросервиса (в режиме DEBUG пишем всё)
* остановка/падение микросервиса

## ФОРМАТ

Общий формат сообщения в логе событий:
```[timestamp] (IN_GAME|SYSTEM) {SOURCE_MICROSERVICE} {severity_level} ("game_session_code"|"") description```, где

* timestamp -  метка времени на сервере
* IN_GAME|SYSTEM - тип события, игровой или системный
* SOURCE_MICROSERVICE - порождающий микросервис (источник)
* severity_level - уровень события, `debug/notification/warning/error/critical`

В том случае, если событие игровое, указать идентификатор и может быть краткое текстовое описание партии, наприм.

```text
 #00232345 Carpov-Korchnoi Bagio 1973 | mv 6 |
```

### Общие замечания

В рамках реализации рекомендуется использовать синглтон, вызывая МС логирования первым при старте вообще всего проекта.

## ЛОГИКА РЕАЛИЗАЦИИ

Простой вариант  -- поднимать REST-сервер на стороне микросервиса, который будет принимать запросы формата JSON с сообщениями об ошибках и сохранять их в БД. при этом на стороне прочих микросервисов нужно будет реализовывать sender

Потенциальные проблемы: что делать, если сервис логов/база недоступна

Вариант второй -- использовать идею каналов: МС логирования считывает сообщения из канала, которые присылают остальные МС, при этом канал не закрывается на протяжении работы всей системы.
Потенциальные проблемы: нужно обговорить нюансы и потенциальные сложности реализации такого в распределённой системе.

____

Физическая реализация хранилища данных - SQL DB, желательно не SQLite.

